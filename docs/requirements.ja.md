# 要求事項

## システムの基本要求

本システムは、多様なMarkdownファイルのフロントマターから統一的な索引を生成するシステムである。以下の要求を満たすこと：

1. **フロントマターの抽出と解析**:
   Markdownファイルからフロントマターを抽出し、Schema定義に基づいて解析する
2. **柔軟な構造対応**:
   事後的に作成された多様なフロントマター構造に対応し、統一的な処理を行う
3. **テンプレート駆動の出力**:
   解析結果をテンプレートに基づいて任意の形式で出力する

## 目的と背景

### システムの目的

- 多様な形式のMarkdownファイルから統一的な索引を生成する
- 事前の厳格なSchema定義なしに作成された既存のMarkdownファイルに対応する
- 運用者依存の入力方法や名称の多様性を吸収する

### 解決すべき課題

- フロントマターの自由な記述形式と索引生成の規則性の両立
- 過去に蓄積されたMarkdownファイルへの対応
- Schema変更時のアプリケーション改修コストの削減

## アーキテクチャ要求

### ドメイン境界の定義

システムは以下の3つの独立したドメインに分離されること：

#### 1. フロントマター解析ドメイン

**責務**: Markdownファイルからフロントマターデータを抽出する

**要求**:

- Markdownファイルの一覧を受け取り、各ファイルを処理する
- `x-frontmatter-part`で指定された階層をフロントマター処理の起点とする
- 抽出したデータを構造化して保持する
- 外部からの直接アクセスは許可しない

#### 2. テンプレート管理ドメイン

**責務**: 出力テンプレートの管理と提供

**要求**:

- `x-template`: メインコンテナのテンプレートファイルを管理する
- `x-template-items`: 配列要素展開用のテンプレートファイルを管理する
- `x-template-format`: 出力形式の指定を管理する
- 要求に応じてテンプレートファイルを提供する

#### 3. データ処理指示ドメイン

**責務**: フロントマターデータの加工と提供

**要求**:

- フロントマター解析結果を受け取り、x-ディレクティブに基づいて処理する
- すべてのデータアクセスを仲介し、処理済みデータのみを提供する
- フロントマター解析ドメインへの直接アクセスを隠蔽する
- Schema階層の要求に応じて適切なデータを返す

### データアクセス原則

システムは以下のデータアクセス原則を遵守すること：

1. **隠蔽原則**:
   フロントマター解析結果への直接アクセスは禁止し、データ処理指示ドメインを経由する
2. **処理済みデータの提供**:
   x-ディレクティブ処理が完了したデータのみを外部に提供する
3. **階層解釈の一貫性**: `type: "array"`の`items`プロパティは階層パスで省略する

## Schema定義の要求

### Schema構造の要求

システムは以下のSchema構造要求を満たすこと：

1. **構造定義の分離**:
   Schemaはフロントマター構造の定義とテンプレート指定を明確に分離する
2. **標準準拠**: JSON Schema
   Draft-07に準拠し、`$ref`による構造の再利用を可能にする
3. **テンプレート指定の一元化**: テンプレートファイルの指定はSchema内で完結する

### Schema機能の分離原則

システムは以下の分離原則を遵守すること：

- **`$ref`の役割**: スキーマ構造の再利用専用とし、テンプレート処理から独立させる
- **テンプレート指定の役割**:
  `x-template`と`x-template-items`でのみ行い、`$ref`と混在させない
- **処理の独立性**: Schema構造の解釈とテンプレート処理を独立したプロセスとする

## テンプレート処理の要求

### 基本要求

システムのテンプレート処理は以下の要求を満たすこと：

1. **完全性**: テンプレートファイルの内容のみが出力を決定する
2. **変数置換**: `{variable.path}`形式の変数を実際の値に置換する
3. **配列展開**: `{@items}`記法により配列要素を展開する
4. **非侵襲性**: Schemaによる出力構造の補完や追加を行わない

### テンプレート変数の解決要求

システムは以下の変数解決規則を実装すること：

1. **起点の区別**:
   - `x-template`内の変数: Schemaのrootを起点とする
   - `x-template-items`内の変数: `x-frontmatter-part`指定階層を起点とする

2. **階層パスの解釈**:
   - ドット記法により階層を表現する（例：`id.full`）
   - 配列の`items`プロパティは階層パスで省略する

### 処理タイミングの要求

システムは以下の処理順序を保証すること：

1. **個別ファイル処理フェーズ**:
   - 各Markdownファイルのフロントマターを個別に処理する
   - デフォルトで構造を保持し、ディレクティブ指定時のみ変換する

2. **統合フェーズ**:
   - 全ファイル処理完了後に`x-frontmatter-part`配列を統合する
   - `{@items}`配列を確定する

3. **展開フェーズ**:
   - 統合されたデータに対してテンプレートを適用する
   - `x-template-items`により各要素を展開する

## 出力形式の要求

システムは以下の出力形式をサポートすること：

- **JSON** (`.json`): 構造化データとしてのJSON形式
- **YAML** (`.yaml`, `.yml`): 人間可読な構造化データ形式
- **Markdown** (`.md`): ドキュメント形式
- **XML** (`.xml`): 構造化マークアップ形式

出力形式の決定はテンプレートとSchemaの指定に基づくこと。

## システム成果物の要求

システムは以下の成果物を提供すること：

1. **設計文書**: ドメイン境界と責務分離を明確にした設計資料
2. **実装コード**: TypeScriptによる堅牢な処理システム
3. **テストスイート**: 各ドメインの単体テストと統合テスト
4. **実行例**: 実用的なユースケースを示す動作可能なサンプル
5. **Schema対応**: JSON Schemaの`$ref`による再帰的な構造解析

## 処理フローの要求

### 初期化フェーズの要求

システムは処理開始時に以下を実行すること：

1. **Schema構造の読み取り**: 引数で指定されたSchemaファイルを解析する
2. **ドメイン分離**: 3つの独立したドメインに処理を分解する
   - フロントマター解析構造の把握
   - テンプレート指定の把握
   - 解析結果データ処理指示の把握
3. **ファイル一覧の作成**: 処理対象のMarkdownファイル一覧を生成する

### 個別ファイル処理の要求

各Markdownファイルに対して以下の処理を実行すること：

1. **フロントマター抽出**: Markdownファイルからフロントマター部分を抽出する
2. **構造解析**: Schema定義に基づいてフロントマターを解析する
3. **データ保持**: 解析結果を構造化データとして保持する
4. **中間表現の構築**: 変数スコープと正規化を管理する中間表現を生成する
5. **コンテキスト生成**: テンプレート変数への値配置を行う

### 統合フェーズの要求

全ファイル処理後に以下を実行すること：

1. **データ統合**: `x-frontmatter-part`指定配列を統合する
2. **ディレクティブ処理**: x-ディレクティブによるデータ変換を適用する
3. **テンプレート適用**: `x-template`と`x-template-items`を用いて出力を生成する
4. **最終出力**: 指定された形式で結果を保存する

### 処理の独立性要求

- `$ref`によるスキーマ構造の再利用はテンプレート処理と独立して動作すること
- 各ドメインは他のドメインの実装詳細に依存しないこと

## フロントマター処理の要求

### 処理起点の定義

システムは`x-frontmatter-part: true`が設定された配列をフロントマター処理の起点とすること。

### 構造変換の要求

システムは以下の構造変換機能を提供すること：

1. **配列フラット化**: `x-flatten-arrays`指定時にネストした配列を平坦化する
2. **構造保持**: ディレクティブ未指定時は元の構造を維持する
3. **単一要素の配列化**: スカラー値を配列として扱う

### 柔軟性の要求

システムは以下の柔軟性を提供すること：

1. **選択的適用**: フラット化の有無を用途に応じて選択可能にする
2. **Schema再利用**: 同一Schemaで多様なフロントマター構造に対応する
3. **段階的移行**: 既存構造を維持しつつ新機能を段階導入可能にする
4. **一貫性の保証**: `{@items}`により統一的な配列展開を行う

### 設計原則

システムは「書き手の自由度と読み手の処理効率の両立」を実現すること：

- フロントマター作成者は自然な構造を選択できる
- Schema定義者は処理方針を宣言的に指定できる
- データ消費者は一貫したインターフェースでアクセスできる

## ディレクティブ仕様の要求

### テンプレート制御ディレクティブ

システムは以下のテンプレート制御ディレクティブをサポートすること：

- **`x-template`**: メインコンテナのテンプレートファイルを指定
- **`x-template-items`**: 配列要素展開時のテンプレートファイルを指定

### データ抽出ディレクティブ

システムは以下のデータ抽出機能を提供すること：

- **`x-frontmatter-part`**: フロントマター処理の起点を示す
- **`x-flatten-arrays`**: 配列構造のフラット化を指定

### データ変換ディレクティブ

システムは以下のデータ変換機能を提供すること：

- **`x-derived-from`**: 他のプロパティから値を集約
- **`x-derived-unique`**: 配列の重複要素を除去
- **`x-jmespath-filter`**: JMESPath式によるデータフィルタリング

### 処理タイミングの保証

システムは以下の処理順序を保証すること：

1. **個別処理**: 各ファイルの独立した処理
2. **統合処理**: 全ファイル完了後の集約処理
3. **展開処理**: テンプレートへの最終的な適用

### 制約事項

システムは以下の制約を遵守すること：

- デフォルト値の生成や補完を行わない
- 存在しないデータへの値の追加を行わない
- 実際のフロントマターデータのみを処理対象とする

## 抽象化の要求

### システムの独立性

システムは以下の独立性を保証すること：

1. **実装の独立性**: 特定の実例やユースケースに依存しない汎用的な実装
2. **Schema変更への耐性**: Schema構造の変更がアプリケーションコードに影響しない
3. **設定による制御**: 処理の詳細は設定や引数で制御可能
4. **宣言的な処理**: すべてのディレクティブは宣言的で処理順序を自動決定

### 処理の一貫性

システムは以下の一貫性を提供すること：

1. **構造の多様性への対応**: 様々なフロントマター構造を統一的に処理
2. **統一的な配列展開**: `{@items}`による一貫した配列処理
3. **段階的な変換**: ディレクティブの組み合わせによる複雑な変換の実現

## 検証の要求

### 実行例の提供

システムは`examples/`ディレクトリに実行可能な使用例を提供すること：

- 実際のユースケースを示す動作可能なサンプル
- 多様なSchema定義とテンプレートの組み合わせ例
- 汎用性を実証する複数のシナリオ

### テストの要求

システムは`tests/`ディレクトリに包括的なテストスイートを提供すること：

- 各ドメインの独立性を検証する単体テスト
- ドメイン間の連携を検証する統合テスト
- 実際のユースケースを検証するE2Eテスト

## 要求理解のための具体例

以下の具体例は、システムが満たすべき要求を正確に理解するための参考例である。システムはこれらの例に限定されず、同様の多様なユースケースに対応できること。

### 例1: コマンドレジストリの索引生成

**目的**: プロンプトファイルからコマンド定義の統一的な索引を生成する

**入力構造の例**:

- 対象: `.agent/climpt/prompts`配下のMarkdownファイル群
- 各ファイルのフロントマターにコマンド定義（c1, c2, c3, description等）が記載

**Schema定義の特徴**:

```json
{
  "x-template": "registry_template.json",
  "x-template-items": "registry_command_template.json",
  "properties": {
    "tools": {
      "properties": {
        "availableConfigs": {
          "x-derived-from": "commands[].c1",
          "x-derived-unique": true
        },
        "commands": {
          "x-frontmatter-part": true,
          "items": { "$ref": "registry_command_schema.json" }
        }
      }
    }
  }
}
```

**要求の実証**:

- `x-frontmatter-part`によるフロントマター処理起点の指定
- `x-derived-from`による他プロパティからの値集約
- `$ref`による構造の再利用とテンプレート処理の独立性
- JSON形式での構造化出力

### 例2: 記事管理システムの索引生成

**目的**: 記事のメタデータから出版用の索引を生成する

**入力構造の例**:

- 対象: `.agent/drafts/articles`配下のMarkdownファイル群
- 各ファイルのフロントマターに記事情報（title, type, topics等）が記載

**Schema定義の特徴**:

```json
{
  "x-template": "books_template.yml",
  "properties": {
    "books": {
      "type": "array",
      "x-frontmatter-part": true,
      "items": {
        "properties": {
          "title": { "type": "string" },
          "topics": {
            "type": "array",
            "x-flatten-arrays": "topics"
          }
        }
      }
    }
  }
}
```

**要求の実証**:

- YAML形式での出力サポート
- `x-flatten-arrays`による選択的な配列フラット化
- 複数ファイルからの統合的な索引生成

### 例3: トレーサビリティ管理

**目的**: 要求IDの追跡可能性を確保する索引生成

**構造変換の例**:

```yaml
# 入力: ネストした配列構造
traceability: [["REQ-001", "REQ-002"], "REQ-003"]

# x-flatten-arrays指定時の出力
["REQ-001", "REQ-002", "REQ-003"]

# 指定なしの場合は構造維持
[["REQ-001", "REQ-002"], "REQ-003"]
```

**要求の実証**:

- フロントマター作成者の自由な記述形式への対応
- 用途に応じた構造変換の選択可能性
- `x-derived-unique`による重複除去

これらの例は、システムが以下の要求を満たすことを示している：

1. **多様な入力形式への対応**: 各例で異なるフロントマター構造を統一的に処理
2. **宣言的な処理指定**: x-ディレクティブによる処理の宣言的な定義
3. **出力形式の柔軟性**: JSON、YAML等の多様な出力形式のサポート
4. **ドメイン分離の実現**:
   Schema定義の変更がアプリケーションコードに影響しない設計
