# 構造化された要求仕様書

## 1. プロセス分解

### 1.1 メインプロセス

#### P1: フロントマター解析プロセス
**誰が**: システム（自動処理）
**何を**: Markdownファイルのフロントマター
**どのように**: 抽出・解析・構造化データへの変換を通じて処理

**サブプロセス**:
1. P1.1: ファイル収集プロセス
2. P1.2: フロントマター抽出プロセス  
3. P1.3: AI解析プロセス
4. P1.4: データ構造化プロセス
5. P1.5: 結果統合プロセス

### 1.2 詳細プロセス分解

#### P1.1: ファイル収集プロセス
**誰が**: システム
**何を**: 指定されたディレクトリ内のMarkdownファイル一覧
**どのように**: ファイルシステムをスキャンして対象ファイルリストを作成
**優先度**: Must Have（必須）
**理由**: 処理対象の特定が全体処理の前提条件となるため

#### P1.2: フロントマター抽出プロセス
**誰が**: Denoランタイム
**何を**: 各Markdownファイルのフロントマター部分
**どのように**: YAMLパーサーを使用して先頭部分から抽出
**優先度**: Must Have（必須）
**理由**: 解析対象データの取得が必須のため

#### P1.3: AI解析プロセス
**誰が**: Claude API（claude -p コマンド）
**何を**: 抽出されたフロントマターデータ
**どのように**: 
- プロンプトAを使用してSchema定義に基づく情報抽出
- プロンプトBを使用してテンプレートへの当て込み
**優先度**: Must Have（必須）
**理由**: 柔軟な解析の中核機能であるため

#### P1.4: データ構造化プロセス
**誰が**: システム
**何を**: AI解析結果
**どのように**: 定義されたSchemaに従って構造化データに変換
**優先度**: Must Have（必須）
**理由**: 出力形式の統一性確保のため

#### P1.5: 結果統合プロセス
**誰が**: システム
**何を**: 個別の解析結果
**どのように**: 全体の解析結果として統合し、指定フォーマットで保存
**優先度**: Must Have（必須）
**理由**: 最終成果物の生成に必要なため

### 1.3 サポートプロセス

#### P2: 設定管理プロセス
**誰が**: システム管理者
**何を**: Schema定義とテンプレート設定
**どのように**: 外部設定ファイルを通じて管理・更新
**優先度**: Must Have（必須）
**理由**: 柔軟性確保の要となる機能のため

#### P3: 検証プロセス
**誰が**: システム
**何を**: 生成された索引データ
**どのように**: テストケースとexamplesを使用した動作確認
**優先度**: Should Have（推奨）
**理由**: 品質保証のため重要だが、コア機能ではない

## 2. ユーザーフロー

### 2.1 メインユーザーフロー

#### UF1: 索引作成フロー
**アクター**: システム利用者（開発者/運用者）
**目的**: Markdownファイル群から索引を生成

**ステップ**:
1. **開始**: 利用者がコマンドを実行
2. **設定指定**: Schema・テンプレート・対象ディレクトリを指定
3. **処理実行**: システムが自動的に全ファイルを処理
4. **結果確認**: 生成された索引ファイルを確認
5. **終了**: 必要に応じて再実行または完了

**MoSCoW分析**:
- Must: ステップ1-4（基本的な実行フロー）
- Should: エラーハンドリングと進捗表示
- Could: 差分処理（変更されたファイルのみ処理）
- Won't: GUI対応（CLIのみで実装）

### 2.2 設定変更フロー

#### UF2: Schema/テンプレート変更フロー
**アクター**: システム管理者
**目的**: 新しい索引形式への対応

**ステップ**:
1. **要求確認**: 新しい索引形式の要求を確認
2. **Schema作成**: 新しいSchema定義ファイルを作成
3. **テンプレート作成**: 対応するテンプレートファイルを作成
4. **設定更新**: アプリケーション設定を更新
5. **動作確認**: examplesで動作を検証
6. **本番適用**: 実際のMarkdownファイルに適用

**MoSCoW分析**:
- Must: ステップ2-4（設定の差し替え機能）
- Should: ステップ5（検証機能）
- Could: 設定のバージョン管理
- Won't: 設定の自動生成

### 2.3 エラー対応フロー

#### UF3: 解析エラー対応フロー
**アクター**: システム利用者
**目的**: 解析失敗時の対処

**ステップ**:
1. **エラー検知**: システムがエラーを検知・報告
2. **原因特定**: ログから原因を特定
3. **対処選択**: 
   - a) フロントマター修正
   - b) Schema/プロンプト調整
   - c) 該当ファイルをスキップ
4. **再実行**: 修正後に処理を再実行
5. **結果確認**: 正常処理を確認

**MoSCoW分析**:
- Must: ステップ1-2（エラー報告機能）
- Should: ステップ3c（スキップ機能）
- Could: エラーの自動修復提案
- Won't: フロントマターの自動修正

## 3. 機能要件定義

### 3.1 コア機能要件

#### FR1: フロントマター抽出機能
- **Must Have**: YAMLフォーマットのフロントマター抽出
- **Should Have**: TOML/JSON形式のサポート
- **Could Have**: カスタム区切り文字対応

#### FR2: AI解析機能
- **Must Have**: claude -pコマンドの実行と結果取得
- **Must Have**: プロンプトの動的生成
- **Should Have**: レート制限対応
- **Could Have**: 他のLLM APIサポート

#### FR3: Schema適用機能
- **Must Have**: 外部Schemaファイルの読み込み
- **Must Have**: Schema検証機能
- **Should Have**: Schema バージョン管理

#### FR4: テンプレート処理機能
- **Must Have**: テンプレートへのデータ当て込み
- **Must Have**: JSON/YAML形式の出力
- **Could Have**: カスタム出力形式

### 3.2 設定管理機能要件

#### FR5: 設定ファイル管理
- **Must Have**: 設定の外部化（Schema、テンプレート、パス）
- **Must Have**: 複数設定プロファイルのサポート
- **Should Have**: 設定の検証機能

## 4. 非機能要件

### 4.1 性能要件
- **Should Have**: 100ファイル/分以上の処理速度
- **Could Have**: 並列処理対応

### 4.2 信頼性要件
- **Must Have**: エラー時の部分的な結果保存
- **Should Have**: リトライ機能

### 4.3 保守性要件
- **Must Have**: モジュール化された設計
- **Must Have**: テストカバレッジ80%以上
- **Should Have**: ドキュメント自動生成

### 4.4 拡張性要件
- **Must Have**: プラグイン可能なアーキテクチャ
- **Must Have**: 新しいSchema/テンプレートの追加が容易

## 5. ドメイン境界

### 5.1 コアドメイン
- **フロントマター解析ドメイン**: 抽出・解析・構造化の中核ロジック
- **Schema管理ドメイン**: Schema定義と検証

### 5.2 サポートドメイン
- **ファイル管理ドメイン**: ファイルシステム操作
- **AI連携ドメイン**: Claude APIとの通信
- **設定管理ドメイン**: 設定ファイルの読み込みと管理

### 5.3 汎用ドメイン
- **ロギング**: エラーと処理ログ
- **ユーティリティ**: 共通処理関数

## 6. 成果物定義

### 6.1 ドキュメント成果物
1. **要求仕様書**（本書）- Must Have
2. **ドメイン設計書** - Must Have
3. **API仕様書** - Should Have
4. **運用マニュアル** - Should Have

### 6.2 実装成果物
1. **コアアプリケーション**（Deno/TypeScript）- Must Have
2. **テストスイート** - Must Have
3. **Claude用プロンプト（2種）** - Must Have
4. **実行例（examples/）** - Must Have
5. **設定ファイルテンプレート** - Should Have

### 6.3 検証成果物
1. **単体テスト** - Must Have
2. **統合テスト** - Should Have
3. **実例1の動作確認** - Must Have
4. **実例2の動作確認** - Must Have

## 7. 制約事項

### 7.1 技術制約
- Denoランタイムの使用
- Claude APIの利用（claude -p）
- JSRパッケージの使用

### 7.2 設計制約
- DDD（ドメイン駆動設計）の適用
- TDD（テスト駆動開発）の実践
- 全体性（Totality）の確保
- AI複雑性制御の実装

### 7.3 運用制約
- CLIベースの実装（GUIなし）
- 設定ファイルベースの管理
- ローカル実行環境での動作