---
c1: debug
c2: analyze-deep
c3: project-issues
title: プロジェクト全体の深掘り調査と修正タスク洗い出し
description: プロジェクト全体を深く調査し、リファクタ課題や重複コード、修正すべき問題を洗い出し、ドメイン駆動設計からテスト駆動設計への移行を支援する
usage: |
  プロジェクト全体の深掘り調査と修正タスクの洗い出しを実行します。
  既存のissue一覧を確認し、適切な処理を行います。
options:
  input: []
  adaptation: []
  file: [false]
  stdin: [true]
  destination: [false]
---

# 指示:

以下の2点を実施して。

1. プロジェクト全体を深く調査し、リファクタ課題や重複コード、修正すべき問題を洗い出して。具体的には「プロジェクトの深掘り調査」を実行すること。
2. ドメイン駆動設計からテスト駆動設計へ進め、テストが要求や仕様書を反映していない箇所を洗い出して。カバレッジよりも仕様のテスト反映を優先すべき。具体的には「設計の実装調査」を実行すること。

## 強固構築方針

- **ドメイン駆動設計**: ビジネスロジックとドメインモデルを中核とした堅牢な設計
- **全域性原則**:
  型安全性による不正状態の完全排除（`docs/development/totality_go.ja.md`参照）
- **強固性重視**: 障害耐性、保守性、拡張性を重視した堅牢な構築
- [AI複雑化防止（科学的制御）](docs/development/ai-complexity-control_compact.ja.md)
- [ハードコーディング禁止規定](docs/development/prohibit-hardcoding.ja.md)

## 必須参照資料

必ず以下の資料を参照してから強固な設計・実装を開始すること：

1. **ドメイン設計**: `docs/domain/domain_boundary-*.md`
2. **サブドメイン設計**: `docs/domain/architecture/**/*.md`
3. **全域性原則**: `docs/development/totality_go.ja.md`
4. **テスト方針**: `docs/tests/README.md`, `docs/tests/testing_guidelines.md`
5. **ハードコーディング禁止規定**: `docs/development/prohibit-hardcoding.ja.md`

### check list

過去のIssueから作成したCheckListであり、この問題が対処済みであることも重要。
チェックリスト: `docs/tests/checklist-based-on-gh-issue.md`

## プロジェクトの深掘り調査

要求が期待するフローの最適案を構築:

### 発散フェーズ:

以下の処理手順に従う。

1. まず「要求」ファイルを読み込む。
2. 「要求」を満たすフローを3パターン考える。開始地点から完了までを網羅すること。
3. ３パターンからランダムに1つ選ぶ（「要求フロー」とする）

要求フローを実行シミュレーション:

4.
「要求フロー」を実現するための実行案を2つ作成する（「要求実行案」とする）

5.
「要求実行案」を2つシミュレーション実行する

6.
「要求実行案」の2つを比較し、実行結果を推測して得る（「要求実行シミュレート案の実行推測結果」とする）

実行推測結果の比較:

7.
「要求実行シミュレーション案の実行推測結果」を相互に比較し、「処理フローの実行結果の振れ幅」を把握する

8.
「処理フローの実行結果の振れ幅」は実装の「揺れ」や「不具合」「二重実装」の温床となることを認識する

9.
実装の振れ幅を減らすために、振れ幅が大きくなる箇所を見定め、「デバッグ対象箇所」と認定する

実装へのデバッグ出力追加:

10.
コードを調べて、「デバッグ対象箇所」へ、十分なデバッグ情報を加える
`inspector-debug trace-error cause-analysis`

11.
デバッグ情報にログレベルを設定し、実行時にログ出力の量や情報量を制御する（文字数、ログ出力）

12.
プロセスでは、if文による特殊分岐がハードコーディングされていないか調べる（要求は特殊解でなく抽象度で満たせ。場当たり的実装を禁ず。）

13.
実際にコードを実行し、デバッグ出力結果を得る

デバッグした結果の評価:

14.
デバッグ実行した結果を、当初の「要求」と照らし合わせる 15.
「要求」に対し、比較した結果が、要求を満たすか判定する

## 設計の実装調査

以下の処理手順に従う。

設計調査:

1. 要求や要件を理解する
2. ドメイン境界線やアーキテクチャなどの設計書を読む
3. 要求に従って考えられる実行例を24個列挙する
4. 24個列挙した実行例をもとに、特殊解に縛る実装を禁止し、要求を抽象度に即して一般解として設計する(「概念的設計」とする)

実装調査:

5.
実装とテストから、分岐が多い箇所や、責任が大きい箇所を選ぶ（それらを「中心点」とする。複数存在する。）

6. 複数の中心点から、ランダムに1つ選ぶ

設計調査と実装調査の比較評価:

7.
選んだ中心点に対し、処理4の設計を元に、「強固構築方針」や「必須参照資料」を元に比較評価する

8. 評価した結果が、要求・要件を満たしているか判定する

9.
判定結果に基づいて、テストが実装されているか調べる
テストには、`inspector-debug plan-logger debug-strategy` で示す BreakdwonLogger 戦略を組み込む。

10.
処理4で導いた設計に基づき、テスト設計を行い、処理9のテスト実装が仕様をテストしているか否か判定する

# 課題がある場合

既存のissue一覧を gh で取得し、問題に近いIssueがあるか調べる。
「近いIssueがない場合」と「近いIssueがある場合」に応じて、処理を変え、実施する。

## 近いIssueがない場合:

gh で 適切なラベルをつけてIssueを作って。

- Issueへ完了条件を明記すること。
- Issueへ「経過をコメントへ残す」旨の記述をすること。

### ラベル

[bug, ci-failure, duplicate, enhancement, refactor, documentation,
high-priority]

## 近いIssueがある場合:

gh でIssue内容を変更する。

- 既存Issueの内容と照らし合わせ、修正点を加筆・修正する。
- 完了条件を見直し、必要な条件を追記・削除する。
- ラベルを見直し、変更する。

Issue コメントへ、変更した点を記載する。

# 何も課題がない場合

ひとつも問題がなく、修正も全て完了している場合は、リリースIssueを作成する。

gh で ラベル "release" を含む Issueを作成して。 全部で30行以内に収めること。

Issueへの登録内容:

- Releaseノートに含める文言
- 実装が確認された内容のサマリー
