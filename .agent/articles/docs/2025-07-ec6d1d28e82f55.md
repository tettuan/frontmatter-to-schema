---
title: "5 hours 連続稼働を実現する、Claude Code Companyのモニタリングツール[tmux-monitor]"
emoji: "🚗"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: [tmux,claudecode]
published: true
published_at: 2025-07-12 11:30
---

## あらすじ

Claude
Codeを長時間稼働させようとした際に、途中で作業が止まってしまう問題に悩まされていませんか？私自身、Claude
Codeを使った開発作業を効率化したいと考える中で、「せっかく複数のpaneで並行作業をセットアップしたのに、気がつくと一部のpaneが止まっている」という状況に何度も遭遇しました。

特に、複雑なプロジェクトでは複数のタスクを同時進行させたいものです。しかし、Claude
Codeの特性上、一定時間が経過すると指示の効力が弱まったり、tmuxで未送信のテキストが残ったままになったりして、結果的に作業が中断してしまうことがあります。

そこで開発したのが「tmux-monitor」です。これは、tmuxの各paneを監視し、空いているpaneや待機状態のpaneを検知して、自動的に新しいタスクを割り当てるモニタリングツールです。このツールを使うことで、**最大5時間の連続稼働**(Claude
Codeの5hours)を実現できるようになりました。

今回は、このtmux-monitorの仕組みと効果、そして実際の運用で感じたメリット・デメリットについて詳しく解説していきます。

![claudecodecompany](/images/2025-07-ec6d1d28e82f55-scnsht.png)

## tmux-monitorの基本的な仕組み

tmux-monitorは、複数のpaneで動作するClaude
Codeの状態を常時監視し、効率的なタスク管理を実現するツールです。その核となる仕組みは以下の3つの要素から構成されています。

### pane自身によるステータス報告

外部監視するだけのツールとは異なり、tmux-monitorでは**各pane自身がステータスを報告する**ようメッセージ送信する方式を採用しています。これは、製造業の自動化工場における「アンドン」システムに似ています。各作業ステーションが自分の状態を可視化することで、全体の効率を最適化するのです。

具体的には、各paneで実行中のClaude Codeが定期的に以下のような状態を報告します：

- `WORKING`: 現在タスクを実行中
- `IDLE`: 待機状態（新しいタスクを受け付け可能）
- `DONE`: タスク完了
- `ERROR`: エラー発生中

この自己報告システムにより、外部からのプロセス監視では判断が困難な「実際の作業状況」を把握できるようになります。

### 空き・待機paneの自動検知

tmux-monitorの重要な機能の一つが、**空き・待機状態のpaneを定期的に検知する**ことです。Claude
Codeは優秀なツールですが、タスクが完了した後は、次の指示待ちで止まってしまいます。

私の経験では、特に以下のような場面で各paneが待機状態になりやすいことがわかりました：

- ファイル編集作業が完了した後
- テストが完了して結果を確認した後
- コミットやpush作業が終了した後

tmux-monitorは、paneへ報告指示をだします。paneが反応しステータスを変更します。それらの結果をまとめ、司令塔のmain
paneに報告します。これにより、各paneの空き状態を知ったmain
paneが追加指示をだし、効率的な並行作業が可能になります。

### 司令塔main paneへのステータス集約

すべてのpaneからの状態報告は、**司令塔役のmain pane**に集約されます。このmain
paneが、全体の指揮官として機能し、適切なタスク配分を行います。

main paneでは、以下のような判断を自動的に行います：

- どのpaneが空いているか
- 次に実行すべき優先度の高いタスクは何か
- 全体の進捗状況はどうか
- リソースの配分は適切か

報告へ反応できるよう、事前に振る舞い定義の指示書を持っておきます。

この集中管理により、複数のpaneを使った並行開発において、人間が細かな管理を行う必要がなくなります。まるで、熟練したプロジェクトマネージャーが常に全体を見渡して、最適な指示を出し続けているような状態を実現できるのです。

## 連続稼働を可能にする効果とその原理

tmux-monitorの導入により、Claude
Codeが**未完了状態で作業を切り上げることが劇的に減り**、長時間にわたって安定稼働し続けるようになります。実際の運用では、2-3時間の連続稼働を何度も達成しており、開発効率が大幅に向上しました。（停止理由の多くは、リミット到達です。）

### 自動タスク配分による作業継続の仕組み

連続稼働を実現する**核心的な原理**は、以下のサイクルにあります：

1. **司令塔が空き・待機paneへ新たなタスクを自動割り当て**
2. **そのタイミングで作業が再トリガーされる**
3. **各paneから新たな状況Updateが司令塔に届く**
4. **届いたUpdateに対応しようと、main paneが再び奮起する**

このサイクルが自動的に回り続けることで、人間の介入なしに作業が継続されます。従来の方式では、一つのタスクが完了すると人間が手動で次の指示を出す必要がありましたが、tmux-monitorではこのプロセスが自動化されているのです。

### Claude Codeの特性を活用した設計思想

Claude
Codeは、CLIインターフェースで最高のパフォーマンスを発揮します。しかし、長時間の自動稼働となると、以下のような課題が生じます：

- **指示の効力減衰**: 最初の指示から時間が経つと、その効力が弱まる
- **コンテキストの散逸**: 長い作業の中で、当初の目的を見失いがち

また、tmux送信でも、時々
**未送信テキストの蓄積**が見られます。入力途中のテキストが送信されずに残る現象です。

tmux-monitorは、これらの課題を **定期的な送信** で解決します。

### Token効率化による持続可能性

長時間の稼働において重要なのが、**Token使用量の最適化**です。以下の戦略でToken無駄遣いを抑止しています。完璧ではありませんが。

**CLAUDE.mdでの/clear指示**:
作業用のpaneでは、単発作業が終わるたびに、定期的にコンテキストをクリアし、不要な履歴を削除
**モニターツールからの自動/clear**:
`DONE`や`IDLE`ステータスを検知したタイミングで自動的にコンテキストをリセット

main pane や、一部の固定役割のpaneはコンテキストを維持します。

これにより、Token使用量を抑えながら、必要な情報は保持するという、バランスの取れた運用が可能になります。

### 実際の開発現場での効果

実際にtmux-monitorを導入した開発プロジェクトでは、以下のような効果を実感しています：

**開発速度の向上**: 複数のタスクが並行して進むため、全体的な開発速度が向上
**エラー対応の迅速化**:
一つのpaneでエラーが発生しても、他のpaneで代替タスクが進行 **作業の継続性**:
人間が離席していても、ある程度の作業が継続される

特に、大規模なリファクタリングや、大量テストの修正において、その効果は顕著に現れます。同じ指示書をもとに、延々と走らせ続けることができます。

## 運用して分かったメリットとデメリット

実際にtmux-monitorを運用して見えてきた、リアルなメリットとデメリットをお伝えします。理想的な自動化ツールのように見えますが、実際の運用では課題もあります。

### メリット：期待を上回る自動化効果

#### 1. 指示効力の自動回復システム

**Claude
Codeへの最初の指示が弱まるころに、タイミングよく指示出しをして再ブーストする**

これは予想以上に効果的でした。Claude
Codeは優秀ですが、長時間の作業では徐々に最初の指示への集中力が散漫になります。tmux-monitorは、この「指示効力の減衰」に対し、定期的な指示を送ることで、常に高いパフォーマンスを維持します。

#### 2. 未送信テキスト問題の解決

**頻繁にpaneへEnterするので、未送信テキストを送信する**

tmux で Claude
Codeを使っていると、テキストが未送信のまま残ったりすることがあります。tmux-monitorは定期的に各paneに`Enter`キーを送信するため、このような未送信テキストが確実に送信されます。

この機能により、「作業が進んでいると思っていたら、実は指示が送信されていなかった」という問題が解消されました。地味ですが、長時間運用では非常に重要な機能です。

#### 3. 予約オプションによる計画的運用

**時間指定(hh:mm)で指示の予約ができるため、limit解除時間+1分後に開始予約できる**

Claude
Codeには利用制限があり、制限が解除されるタイミングで即座に作業を再開したいケースがよくあります。tmux-monitorの予約機能を使えば、制限解除時刻の1分後に自動的に作業を開始するよう設定できます。

例えば、2時間後に制限が解除される場合、2+5=7時間の自動運用時間を確保できます。これにより、夜間や休日でも効率的に開発を進められるようになりました。

#### 4. 12時間連続運用の実現

**4時間で監視は自動終了するので、予約を2本しておけば2+5+5=12時間の自由時間が得られる**

応用編として、予約オプションを組み合わせることで、理論上は12時間の連続稼働も可能になります。

### デメリット：現実的な運用課題

#### 1. OAuth認証の不安定性

**ときどきClaude CodeのOAuthが切れるので予約が起動しない**

最も頻繁に遭遇する問題がこれです。Claude
CodeのOAuth認証は定期的に更新が必要で、長時間の無人運用中に認証が切れると、予約していた作業が開始されません。

この問題の対策として、重要な作業前には必ず認証状態を確認するようにしていますが、完全に解決するのは困難です。Claude
Code Action のようなクラウドベースとの違いです。

#### 2. 環境依存による制約

tmux-monitorはローカル環境で動作するため、以下のような制約があります：

- macOSまたはLinux環境が必要
- tmuxの設定が必要
- 特定のディレクトリ構造に依存

クラウドベースのソリューションと比較すると、環境依存性は大きなデメリットです。しかし、その分カスタマイズ性は高く、個人の開発環境に合わせた最適化が可能です。

## 参考例として公開

### JSRでの公開とオープンソース化

tmux-monitorは、**https://jsr.io/@aidevtool/tmux-monitor** で公開しています。

自分にとっては、JSRでの公開により、インストールせずに、どのプロジェクトでも使えるメリットがあります：

### 独自環境依存の実装について

現在の実装では、私の開発環境に特化した部分があり、**そのままplainな状態では使えない**ことをお断りしておきます。これは意図的な設計選択で、汎用性よりも実用性を重視した結果です。

#### 主な環境依存要素

**13pane構成を前提とした設計**

私の開発環境では、tmuxを13個のpaneに分割して使用しています。これは以下のような用途に分かれています：

- pane 1: メインの開発作業
- pane 2-4: ワーカープールマネージャー、秘書役
- pane 5-13: ワーカー

雰囲気、Goのゴルーチンをイメージした指示書にしています。

**`cld` エイリアスへの依存**

コード内で `cld` というエイリアスを多用しています。これは私の環境では `claude`
コマンドのエイリアスですが、一般的ではありません。

**指示書ファイルの存在前提**

tmux-monitorは、特定のディレクトリに配置された指示書ファイル（`CLAUDE.md`,
`instructions/*.md`
など）の存在を前提としています。これらのファイルには、各paneで実行すべきタスクの詳細が記述されており、監視ツールがこれを読み取るよう指示をします。

#### ステータス検知の限界

現在の実装では、**statusは完璧ではない**という制約があります。これは以下のような理由によります：

- Claude Codeの出力パターンが完全に予測できない
- tmuxのpane状態取得にタイムラグがある
- ネットワーク状況によるレスポンス遅延

実用上は通知するだけでもマシという感じで機能しますが、ステータス表明に100%の精度を期待すると期待外れとなります。

## まとめ：AI開発支援ツールの新たな可能性

tmux-monitorの開発と運用を通じて、**AI開発支援ツールの自動化には大きな可能性がある**ことを実感しています。Claude
Codeでも、人間の管理なしには長時間の安定稼働は困難でしたが、適切な監視・管理システムを組み合わせることで、その能力を最大限に引き出せることがわかりました。

### 開発効率への実際のインパクト

私自身の開発ワークフローでは、tmux-monitor導入により以下のような変化がありました：

- **作業の継続性向上**: 離席時間を気にせず、長時間の作業を任せられる
- **並行作業の最適化**: 複数のタスクが効率的に並行実行される
- **エラー回復の自動化**: 一部のpaneでエラーが発生しても、全体の作業が止まらない

特に、大規模なリファクタリングや、エラーの修正作業において、その効果は顕著です。頻繁に指示していた状態から、数時間単位で指示を1つ送るだけ、というスタイルに変わりました。

### 技術的な学びと課題

今回の開発で得られた重要な学びは、**AIツールの特性を理解した上で、適切な補完システムを構築することの重要性**です。Claude
Codeは非常に優秀ですが、長時間稼働における以下の特性を考慮する必要があります：

- 指示効力の時間的減衰
- コンテキストの散逸
- OAuth認証の更新サイクル

これらの特性を理解し、技術的に補完することで、AI開発支援ツールの真価を発揮できるように思います。

### 今後のAI開発支援ツールの方向性

tmux-monitorのような監視・管理ツールは、今後のAI開発支援エコシステムにおいて重要な役割を果たすと考えています。Claude
Code
Actionのようなクラウドネイティブなソリューションの登場により、環境依存の問題は解決されるでしょうが、監視・最適化の仕組み自体の価値は変わりません。

将来的には、以下のような発展が期待されます：

- **より洗練されたステータス検知**
- **複数ブランチ間での進捗取り込み**

### 最後に

tmux-monitorは、現時点では私の個人的な開発環境に特化したツールですが、その根底にある考え方や仕組みは、より広く応用できるものだと考えています。AIツールとの協働において、「横から支援する」ことの重要性を、この開発を通じて改めて実感しました。

Claude
Codeの長時間稼働に課題を感じている方へ、tmux-monitorの考えが参考になれば幸いです。

---

*この記事は、元ネタから Claude が拡張して書いています。
